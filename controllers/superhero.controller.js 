const fetch = require('node-fetch');
const { SUPERHERO_BASE_URL } = require('../config/env.js');

/* =========================
   ğŸ”§ FUNCIÃ“N AUXILIAR
   Hace la peticiÃ³n a Superhero API
========================== */
async function fetchSuperhero(endpoint) {
  try {
    const res = await fetch(`${SUPERHERO_BASE_URL}/${endpoint}`);
    if (!res.ok) throw new Error(`Superhero API error: ${res.status}`);
    const data = await res.json();
    return data;
  } catch (error) {
    console.error('âŒ Error fetch Superhero:', error.message);
    throw error;
  }
}

/* =========================
   ğŸ“‹ TODOS LOS PERSONAJES (A-Z)
========================== */
async function getAllCharacters(req, res) {
  try {
    console.log('ğŸ“‹ Obteniendo todos los personajes A-Z...');
    
    const letters = 'abcdefghijklmnopqrstuvwxyz'.split('');
    const allCharacters = [];
    const seenIds = new Set();

    // BÃºsquedas en paralelo por letra
    const promises = letters.map(letter => fetchSuperhero(`search/${letter}`));
    const results = await Promise.all(promises);

    // Combinar resultados y eliminar duplicados
    results.forEach(data => {
      if (data.response === 'success' && data.results) {
        data.results.forEach(char => {
          if (!seenIds.has(char.id)) {
            seenIds.add(char.id);
            allCharacters.push({
              id: char.id,
              name: char.name,
              image: char.image.url,
              publisher: char.biography.publisher,
              alignment: char.biography.alignment
            });
          }
        });
      }
    });

    // Ordenar alfabÃ©ticamente
    allCharacters.sort((a, b) => a.name.localeCompare(b.name));

    console.log(`âœ… Total personajes encontrados: ${allCharacters.length}`);
    res.json({ success: true, total: allCharacters.length, data: allCharacters });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
}

/* =========================
   ğŸ” BUSCAR POR NOMBRE
========================== */
async function searchByName(req, res) {
  try {
    const { name } = req.params;
    console.log('ğŸ” Buscando:', name);

    const data = await fetchSuperhero(`search/${name}`);

    if (data.response === 'error') {
      return res.status(404).json({ success: false, error: 'Personaje no encontrado' });
    }

    // Devolver lista con datos bÃ¡sicos
    const characters = data.results.map(char => ({
      id: char.id,
      name: char.name,
      image: char.image.url,
      publisher: char.biography.publisher,
      alignment: char.biography.alignment
    }));

    res.json({ success: true, data: characters });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
}

/* =========================
   ğŸ‘¤ PERSONAJE POR ID (completo)
   Trae TODA la informaciÃ³n
========================== */async function getCharacterById(req, res) {
  try {
    const { id } = req.params;
    console.log('ğŸ‘¤ Cargando personaje:', id);

    const data = await fetchSuperhero(id);

    if (data.response === 'error') {
      return res.status(404).json({ success: false, error: 'Personaje no encontrado' });
    }

    const character = {
      id: data.id,
      name: data.name,
      image: data.image.url,
      powerstats: data.powerstats,
      biography: data.biography,
      appearance: data.appearance,
      work: data.work,
      connections: data.connections
    };

    res.json({ success: true, data: character });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
}

/* =========================
   ğŸ“Š SOLO POWERSTATS
========================== */
async function getPowerstats(req, res) {
  try {
    const { id } = req.params;
    const data = await fetchSuperhero(`${id}/powerstats`);

    res.json({ success: true, data: data.powerstats });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
}

/* =========================
   ğŸ“– SOLO BIOGRAFÃA
========================== */
async function getBiography(req, res) {
  try {
    const { id } = req.params;
    const data = await fetchSuperhero(`${id}/biography`);

    res.json({ success: true, data: data.biography });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
}

/* =========================
   ğŸ‘ï¸ SOLO APARIENCIA
========================== */
async function getAppearance(req, res) {
  try {
    const { id } = req.params;
    const data = await fetchSuperhero(`${id}/appearance`);

    res.json({ success: true, data: data.appearance });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
}

/* =========================
   ğŸ’¼ SOLO TRABAJO
========================== */
async function getWork(req, res) {
  try {
    const { id } = req.params;
    const data = await fetchSuperhero(`${id}/work`);

    res.json({ success: true, data: data.work });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
}

/* =========================
   ğŸ”— SOLO CONEXIONES
========================== */
async function getConnections(req, res) {
  try {
    const { id } = req.params;
    const data = await fetchSuperhero(`${id}/connections`);

    res.json({ success: true, data: data.connections });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
}

/* =========================
   ğŸ–¼ï¸ SOLO IMAGEN
========================== */
async function getImage(req, res) {
  try {
    const { id } = req.params;
    const data = await fetchSuperhero(`${id}/image`);

    res.json({ success: true, data: data.image });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
}

module.exports = {
  getAllCharacters,
  searchByName,
  getCharacterById,
  getPowerstats,
  getBiography,
  getAppearance,
  getWork,
  getConnections,
  getImage
};
